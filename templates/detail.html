{% extends "base.html" %}
{% block init %}
			const sb = document.getElementById('sb');
			sb.style.display = '';
			const viz = document.getElementById('viz');
{%- endblock %}
{% block script %}
		let frags = {};
		let zoom = {};
		const san = x => x.replaceAll('"', '');
		const sb_load = () => {
			sb.innerText = '. Storyboard loading...';
			let req = new XMLHttpRequest();
			req.addEventListener('load', () => {
				try {
					for (let i = 0; i < req.response.length; i++) {
						let f = req.response[i];
						frags[f.format_id] = f.fragments;
					}
					let f = frags['sb1'];
					let total = 0;
					for (var j = 0; j < f.length; j++) {
						total += f[j].duration;
						if (total > 55*60) {
							return sb_show(j, j+1);
						}
					}
					return sb_show(j-1, j);
				} catch(e) {
					console.log(e);
				}
				sb_fail();
			});
			req.addEventListener('error', sb_fail);
			req.open('GET', '/storyboard/{{ item.video_id }}');
			req.responseType = 'json';
			req.send();
		};
		const sb_fail = () => sb.innerText = '. Storyboard is :(';
		const sb_show = (start, stop) => {
			let h = '';
			let t = 0;
			if (start > 0) {
				h += `<a href="javascript:sb_show(0, ${stop})"/>All</a>. `;
				h += `<a href="javascript:sb_show(${start-1}, ${stop})"/>More</a>`;
			}
			for (let i = 0; i < stop; i++) {
				if (i >= start) {
					if (i in zoom) {
						let t2 = t;
						for (let j = 0; j < 4; j++) {
							if (i*4+j >= frags['sb0'].length) break;
							let f = frags['sb0'][i*4+j];
							h += `<div>At ${clock(t2)}</div><img class="min" onclick="delete zoom[${i}]; sb_show(${start}, ${stop})" src="${san(f.url)}">`;
							t2 += f.duration;
						}
					} else {
						h += `<div>At ${clock(t)}</div><img class="max" onclick="zoom[${i}]=1; sb_show(${start}, ${stop})" src="${san(frags['sb1'][i].url)}">`;
					}
				}
				t += frags['sb1'][i].duration;
			}
			h += `<div>At ${clock(t)}</div>`;
			if (stop < frags['sb1'].length) {
				h += `<a href="javascript:sb_show(${start}, ${stop+1})"/>More</a>. `;
				h += `<a href="javascript:sb_show(${start}, ${frags['sb1'].length})"/>All</a>`;
			}
			sb.innerText = '';
			viz.innerHTML = h;
		};
		const pad = (i) => i > 9 ? i : '0'+i;
		const clock = (t) => {
			t = Math.round(t);
			let s = t % 60;
			t = Math.round((t-s)/60);
			let m = t % 60;
			return `${Math.round((t-m)/60)}:${pad(m)}:${pad(s)}`;
		};
{%- endblock %}
{% block style %}
		img, textarea { border-radius: 1ex; margin-right: 1ex; width: 480px; }
		textarea { border: solid 1px #999; height: 114px; padding: 2px; width: 474px; }
		button { background: #9994; border: solid 1px #999; }
		.max { cursor: zoom-in; }
		.min { cursor: zoom-out; }
		#viz { margin: 1em 0; }
{%- endblock %}
{% block title %} - {{ item.title }}{% endblock %}
{% block preheader %}<a href="/">{% endblock %}
{% block postheader %}</a>{% endblock %}
{% block content %}
	{%- if msg %}
	<p>{{ msg }}</p>
	{%- endif %}
	<h2>{{ item.title }}</h2>
	<div>
		{%- if next %}<a href="/detail/{{ next.video_id }}">↑ Next</a>{% if prev %}. {% endif %}{% endif %}
		{%- if prev %}<a href="/detail/{{ prev.video_id }}">Previous ↓</a>{% endif -%}
	</div>
	<div id="viz">
		<img height="270" src="https://i.ytimg.com/vi/{{ item.video_id }}/maxresdefault.jpg"/>
	</div>
	<a href="https://www.youtube.com/watch?v={{ item.video_id }}">Watch</a><span id="sb" style="display:none">.
	<a href="javascript:sb_load()">Show storyboard</a></span><br/>
	Published at {{ item.video_published_at }}.
	Estimated air date {{ item.video_published_at|to_date }}
	<form action="/save-detail/{{ item.video_id }}" method="post">
		<h3><label for="notes">Notes</label></h3>
		<details>
			<summary>How the heck does this work?</summary>
			<ul>
				<li>list short notes in order of their occurrence, separated by commas</li>
				<li>"egg" and "event" have special behavior<ul>
					<li>say "egg 321" or "event 123" to anchor the # for that note</li>
					<li>say "!egg" or "!event" to automatically derive the # from other notes</li>
					<li>need at least one anchor for derivation to work</li>
					<li>derived numbers have a little ʹ to indicate it</li>
				</ul></li>
				<li>total length of notes for each video is currently limited to 100 characters</li>
			</ul>
		</details>
		<textarea id="notes" name="notes">{% if detail.entries %}{{ (detail.entries|last).notes }}{% endif %}</textarea><br/>
		<input type="hidden" name="etag" value="{{ detail.etag }}"/>
		{%- if admin %}<button type="submit">Save</button> (your email will be recorded but not made visible to anyone){% endif %}
	</form>
	{%- if detail.entries %}
	<h3>History</h3>
	{%- for entry in detail.entries|reverse %}
	<details>
		<summary>At {{ entry.timestamp }}</summary>
		<pre>{{ entry.notes }}</pre>
	</details>
	{%- endfor %}
	{%- endif %}
{%- endblock %}
